<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>BattleBit current server data | Battlebit Dashboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight,alt,wide.css">
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight,alt,wide.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.css">
<link rel="modulepreload" href="./_observablehq/client.js">
<link rel="modulepreload" href="./_observablehq/runtime.js">
<link rel="modulepreload" href="./_observablehq/stdlib.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.js">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6.13/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/binary-search-bounds@2.0.5/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-array@3.2.4/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-axis@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-brush@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-chord@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-color@3.1.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-contour@4.0.2/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-delaunay@6.0.4/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-dispatch@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-drag@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-dsv@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-ease@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-fetch@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-force@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-format@3.1.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-geo@3.1.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-hierarchy@3.1.2/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-interpolate@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-path@3.1.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-polygon@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-quadtree@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-random@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-scale@4.0.2/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-selection@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-shape@3.2.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-time-format@4.1.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-time@3.1.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-timer@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-transition@3.0.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3-zoom@3.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/d3@7.8.5/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/htl@0.3.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/internmap@2.0.3/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/interval-tree-1d@1.0.4/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/isoformat@0.2.1/+esm">
<link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/robust-predicates@3.0.2/+esm">
<script type="module">

import {define} from "./_observablehq/client.js";

define({id: "40313a35", outputs: ["json","jsonData"], body: async () => {
async function json(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error(`fetch failed: ${response.status}`);
  return await response.json();
}
const jsonData = await json("https://publicapi.battlebit.cloud/Servers/GetServerList");
return {json,jsonData};
}});

define({id: "708df930", inputs: ["jsonData","json"], outputs: ["sumPlayers","sumQueuePlayers","uniqueMapCount","serverCount","playerCount","historicalData","latestHistoricalObservation","latestHistoricalPlayers","latestHistoricalQueuePlayers","formatDifference","diffInPlayers","diffInQueuePlayers","diffInServers","diffInMaps","queueCount","mapCount","selectKeys","keysToSelect","jsonTable"], body: async (jsonData,json) => {
const sumPlayers = data => data.reduce((acc, d) => acc + d.Players, 0);

const sumQueuePlayers = data => data.reduce((acc, d) => acc + d.QueuePlayers, 0);

const uniqueMapCount = data => new Set(data.map(d => d.Map)).size;

let serverCount = jsonData.length;

let playerCount = sumPlayers(jsonData);

const historicalData = await json("https://raw.githubusercontent.com/bradfordjohnson/battlebit-dashboard/main/data/historicServerData.json");

const latestHistoricalObservation = historicalData.slice(-1)[0];

const latestHistoricalPlayers = latestHistoricalObservation.data.reduce((acc, d) => acc + d.Players, 0);

const latestHistoricalQueuePlayers = latestHistoricalObservation.data.reduce((acc, d) => acc + d.QueuePlayers, 0);

const formatDifference = (a, b) => {
  const diff = a - b;

  if(diff >= 0){
    return `+${diff}`;
  } else {
    return diff
  }
}

const diffInPlayers = formatDifference(playerCount,latestHistoricalPlayers);

const diffInQueuePlayers = formatDifference(sumQueuePlayers(jsonData),latestHistoricalQueuePlayers);

const diffInServers = formatDifference(serverCount,latestHistoricalObservation.data.length);

const diffInMaps = formatDifference(uniqueMapCount(jsonData),uniqueMapCount(latestHistoricalObservation.data));

let queueCount = sumQueuePlayers(jsonData);

let mapCount = uniqueMapCount(jsonData);

function selectKeys(originalObject, keysToSelect) {
    // Check if originalObject is not null, undefined, or an empty object
    if (!originalObject || typeof originalObject !== 'object' || Object.keys(originalObject).length === 0) {
        return {};
    }
    
    return Object.fromEntries(
        Object.entries(originalObject)
            .filter(([key, value]) => keysToSelect.includes(key))
    );
}

const keysToSelect = ['Name', 'Players', 'QueuePlayers', 'Region', 'Map', 'Gamemode'];

// Assuming jsonData is defined elsewhere in your code

const jsonTable = jsonData.map(obj => selectKeys(obj, keysToSelect));
return {sumPlayers,sumQueuePlayers,uniqueMapCount,serverCount,playerCount,historicalData,latestHistoricalObservation,latestHistoricalPlayers,latestHistoricalQueuePlayers,formatDifference,diffInPlayers,diffInQueuePlayers,diffInServers,diffInMaps,queueCount,mapCount,selectKeys,keysToSelect,jsonTable};
}});

define({id: "0be59fb4", inline: true, inputs: ["playerCount","display"], body: async (playerCount,display) => {
display(await(
playerCount
))
}});

define({id: "778c8ed7", inline: true, inputs: ["diffInPlayers","display"], body: async (diffInPlayers,display) => {
display(await(
diffInPlayers
))
}});

define({id: "59ccca96", inline: true, inputs: ["queueCount","display"], body: async (queueCount,display) => {
display(await(
queueCount
))
}});

define({id: "d3c00353", inline: true, inputs: ["diffInQueuePlayers","display"], body: async (diffInQueuePlayers,display) => {
display(await(
diffInQueuePlayers
))
}});

define({id: "37681012", inline: true, inputs: ["serverCount","display"], body: async (serverCount,display) => {
display(await(
serverCount
))
}});

define({id: "a0bc5b02", inline: true, inputs: ["diffInServers","display"], body: async (diffInServers,display) => {
display(await(
diffInServers
))
}});

define({id: "c39b0305", inline: true, inputs: ["mapCount","display"], body: async (mapCount,display) => {
display(await(
mapCount
))
}});

define({id: "42d9458c", inline: true, inputs: ["diffInMaps","display"], body: async (diffInMaps,display) => {
display(await(
diffInMaps
))
}});

define({id: "695b9efa", inline: true, inputs: ["Inputs","jsonTable","display"], body: async (Inputs,jsonTable,display) => {
display(await(
Inputs.table(jsonTable, {sort: "Players", reverse: true})
))
}});

define({id: "638e5c51", inputs: ["Plot"], outputs: ["regionBar","mapSizeBar"], body: (Plot) => {
const regionBar = data => {
  const regionMap = new Map();
  for (let i = 0; i < data.length; i++) {
    const region = data[i].Region;
    if (regionMap.has(region)) {
      regionMap.set(region, regionMap.get(region) + data[i].Players);
    } else {
      regionMap.set(region, data[i].Players);
    }
  }
  const chartData = Array.from(regionMap, ([region, players]) => ({Region: region, Players: players}));
  return Plot.barY(chartData, {x: "Region", y: "Players", sort: {x: "-y"}}).plot()
}

function mapSizeBar(data) {
  const mapsizeMap = new Map();
  for (let i = 0; i < data.length; i++) {
    const mapsize = data[i].MapSize;
    if (mapsizeMap.has(mapsize)) {
      mapsizeMap.set(mapsize, mapsizeMap.get(mapsize) + data[i].Players);
    } else {
      mapsizeMap.set(mapsize, data[i].Players);
    }
  }
  const chartData = Array.from(mapsizeMap, ([mapsize, players]) => ({MapSize: mapsize, Players: players}));
  return Plot.barY(chartData, {x: "MapSize", y: "Players", sort: {x: "-y"}}).plot()
}
return {regionBar,mapSizeBar};
}});

define({id: "ce79da50", inline: true, inputs: ["regionBar","jsonData","display"], body: async (regionBar,jsonData,display) => {
display(await(
regionBar(jsonData)
))
}});

define({id: "6f6f1514", inline: true, inputs: ["gamemodeBar","jsonData","display"], body: async (gamemodeBar,jsonData,display) => {
display(await(
gamemodeBar(jsonData)
))
}});

define({id: "4ac34bca", inline: true, inputs: ["mapSizeBar","jsonData","display"], body: async (mapSizeBar,jsonData,display) => {
display(await(
mapSizeBar(jsonData)
))
}});

define({id: "d8b86efe", inputs: ["historicalData"], outputs: ["firstDate","lastIndex","lastDate","dataSnapshotCount"], body: (historicalData) => {
const firstDate = historicalData[0].date;
const lastIndex = historicalData.length - 1;
const lastDate = historicalData[lastIndex].date;

let dataSnapshotCount = historicalData.length;
return {firstDate,lastIndex,lastDate,dataSnapshotCount};
}});

define({id: "098596ec", inline: true, inputs: ["dataSnapshotCount","display"], body: async (dataSnapshotCount,display) => {
display(await(
dataSnapshotCount
))
}});

define({id: "84f4f538", inline: true, inputs: ["firstDate","display"], body: async (firstDate,display) => {
display(await(
firstDate
))
}});

define({id: "e9f12688", inline: true, inputs: ["lastDate","display"], body: async (lastDate,display) => {
display(await(
lastDate
))
}});

define({id: "6c5ac83d", inputs: ["historicalData"], outputs: ["sumPlayers","summedData"], body: (historicalData) => {
function sumPlayers(data) {
  let sums = {};
  
  // Iterate over the array of objects
  data.forEach(obj => {
    let datetime = new Date(obj.date).getTime(); // Convert string datetime to milliseconds since UNIX epoch
    
    // Initialize sums for this datetime
    let sumPlayers = 0;
    let sumQueuePlayers = 0;
    
    // Iterate over each item in the nested data array
    obj.data.forEach(item => {
      sumPlayers += item.Players;
      sumQueuePlayers += item.QueuePlayers;
    });

    // Store sums for each datetime
    sums[datetime] = { sumPlayers, sumQueuePlayers };
  });
  
  // Convert sums object to array of objects with datetime and sums
  let result = Object.keys(sums).map(datetime => ({
    datetime: parseInt(datetime), // Convert back to integer
    sumPlayers: sums[datetime].sumPlayers,
    sumQueuePlayers: sums[datetime].sumQueuePlayers
  }));
  
  return result;
}

let summedData = sumPlayers(historicalData);
return {sumPlayers,summedData};
}});

define({id: "7104a034", inputs: ["historicalData"], outputs: ["sumPlayersByRegionAndDate","summedDataByRegion"], body: (historicalData) => {
function sumPlayersByRegionAndDate(data) {
  let sums = {};
  
  // Iterate over the array of objects
  data.forEach(obj => {
    let datetime = obj.date; // Keep date and time as one field
    
    // Group by Region
    obj.data.forEach(item => {
      let region = item.Region;
      let date = datetime.split(' ')[0]; // Extract date
      
      if (!sums[date]) {
        sums[date] = {};
      }
      
      if (!sums[date][region]) {
        sums[date][region] = { totalPlayers: 0, totalQueuePlayers: 0, totalServers: new Set() };
      }
      
      sums[date][region].totalPlayers += item.Players;
      sums[date][region].totalQueuePlayers += item.QueuePlayers;
      sums[date][region].totalServers.add(item.Name);
    });
  });
  
  // Convert sums object to array of objects with Date, Region, and sums
  let result = [];
  for (let date in sums) {
    for (let region in sums[date]) {
      result.push({
        date,
        region,
        totalPlayers: sums[date][region].totalPlayers,
        totalQueuePlayers: sums[date][region].totalQueuePlayers,
        totalServers: sums[date][region].totalServers.size
      });
    }
  }
  
  return result;
}

let summedDataByRegion = sumPlayersByRegionAndDate(historicalData);
return {sumPlayersByRegionAndDate,summedDataByRegion};
}});

define({id: "d51ded1c", inputs: ["Plot"], outputs: ["regionLinePlot","linePlot","boxplot"], body: (Plot) => {
function regionLinePlot(data) {
  return Plot.plot({
    color: {legend: true},
    x: { type: "utc", grid: true },
    y: {grid: true},
    marks: [
      Plot.line(data, {x: "date", y: "totalPlayers", curve: "natural", stroke: "region"}),
      Plot.crosshair(data, {x: "date", y: "totalPlayers", color: "region"})
    ]
  })
}

const linePlot = (data) => {
  const maxPlayers = Math.max(...data.map(d => d.sumPlayers));
  return Plot.plot({
    x: { type: "utc", grid: true },
    y: {grid: true},
    marks: [
      Plot.ruleY([0]),
      Plot.line(data, { x: "datetime", y: "sumPlayers", curve: "natural", stroke: "blue" }),
      Plot.crosshair(data, {x: "datetime", y: "sumPlayers", color: "blue"})
    ]
  });
}

function boxplot(data) {
    return Plot.plot({
  y: {
    grid: true,
    inset: 6
  },
  marks: [
    Plot.boxY(data, {x: "region", y: "totalPlayers"})
  ]
})
}
return {regionLinePlot,linePlot,boxplot};
}});

define({id: "c5b2489c", inline: true, inputs: ["linePlot","summedData","display"], body: async (linePlot,summedData,display) => {
display(await(
linePlot(summedData)
))
}});

define({id: "753123e9", inline: true, inputs: ["regionLinePlot","summedDataByRegion","display"], body: async (regionLinePlot,summedDataByRegion,display) => {
display(await(
regionLinePlot(summedDataByRegion)
))
}});

define({id: "44a8650f", inline: true, inputs: ["boxplot","summedDataByRegion","display"], body: async (boxplot,summedDataByRegion,display) => {
display(await(
boxplot(summedDataByRegion)
))
}});

</script>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<div id="cell-40313a35" class="observablehq observablehq--block"></div>
<div id="cell-708df930" class="observablehq observablehq--block"></div>
<h1 id="battlebit-current-server-data" tabindex="-1"><a class="observablehq-header-anchor" href="#battlebit-current-server-data">BattleBit current server data</a></h1>
<div class="grid grid-cols-4">
<a class="card" style="color: inherit;">
    <h2>Players in game</h2>
    <span class="big"><span id="cell-0be59fb4" class="observablehq--loading"></span></span>
    <span class="muted"><span id="cell-778c8ed7" class="observablehq--loading"></span></span>
  </a>
  <a class="card" style="color: inherit;">
    <h2>Players in queue</h2>
    <span class="big"><span id="cell-59ccca96" class="observablehq--loading"></span></span>
    <span class="muted"><span id="cell-d3c00353" class="observablehq--loading"></span></span>
  </a>
  <a class="card" style="color: inherit;">
    <h2>Community servers</h2>
    <span class="big"><span id="cell-37681012" class="observablehq--loading"></span></span>
    <span class="muted"><span id="cell-a0bc5b02" class="observablehq--loading"></span></span>
  </a>
  <a class="card" style="color: inherit;">
    <h2>Unique maps</h2>
    <span class="big"><span id="cell-c39b0305" class="observablehq--loading"></span></span>
    <span class="muted"><span id="cell-42d9458c" class="observablehq--loading"></span></span>
  </a>
</div>
<div class="grid grid-cols-1">
<a class="card" style="color: inherit;">
<h2>Current online servers</h2>
 <span class="big"><span id="cell-695b9efa" class="observablehq--loading"></span></span>
 </a>
</div>
<div id="cell-638e5c51" class="observablehq observablehq--block"></div>
<div class="grid grid-cols-2">
  <a class="card" style="color: inherit;">
    <h2>Players by region</h2>
    <span class="big"><span id="cell-ce79da50" class="observablehq--loading"></span></span>
  </a>
<!----  <a class="card" style="color: inherit;">
    <h2>Players by Gamemode</h2>
    <span class="big"><span id="cell-6f6f1514" class="observablehq--loading"></span></span>
  </a>---->
  <a class="card" style="color: inherit;">
    <h2>Players by Map Size</h2>
    <span class="big"><span id="cell-4ac34bca" class="observablehq--loading"></span></span>
  </a>
</div>
<h1 id="historical-server-data" tabindex="-1"><a class="observablehq-header-anchor" href="#historical-server-data">Historical server data</a></h1>
<div id="cell-d8b86efe" class="observablehq observablehq--block"></div>
<div class="grid grid-cols-4">
    <a class="card" style="color: inherit;">
        <h2>Data snapshot count</h2>
        <span class="big"><span id="cell-098596ec" class="observablehq--loading"></span></span>
        <span class="muted"></span>
    </a>
    <a class="card" style="color: inherit;">
        <h2>First snapshot at</h2>
        <span class="big"><span id="cell-84f4f538" class="observablehq--loading"></span></span>
        <span class="muted">UTC</span>
    </a>
    <a class="card" style="color: inherit;">
        <h2>Latest snapshot at</h2>
        <span class="big"><span id="cell-e9f12688" class="observablehq--loading"></span></span>
        <span class="muted">UTC</span>
    </a>
<div class="card">
    <a href="https://github.com/bradfordjohnson/battlebit-dashboard/actions/workflows/logServerData.yaml" target="_blank">
        <h2>Current workflow status</h2>
        <span class="big">
            <img src="https://github.com/bradfordjohnson/battlebit-dashboard/actions/workflows/logServerData.yaml/badge.svg" alt="Description of the image">
        </span>
    </a>
</div>
</div>
<div id="cell-6c5ac83d" class="observablehq observablehq--block"></div>
<div id="cell-7104a034" class="observablehq observablehq--block"></div>
<div id="cell-d51ded1c" class="observablehq observablehq--block"></div>
<div class="grid grid-cols-2">
    <a class="card" style="color: inherit;">
        <h2>Players by hour</h2>
        <span class="big"><span id="cell-c5b2489c" class="observablehq--loading"></span></span>
    </a>
    <a class="card" style="color: inherit;">
        <h2>Players by date and region</h2>
        <span class="big"><span id="cell-753123e9" class="observablehq--loading"></span></span>
    </a>
    <a class="card" style="color: inherit;">
        <h2>Observed daily players</h2>
        <span class="big"><span id="cell-44a8650f" class="observablehq--loading"></span></span>
    </a>
</div></main>
<footer id="observablehq-footer">
<div>Built with <a href="https://observablehq.com/" target="_blank">Observable</a> on <a title="2024-02-26T17:51:43">Feb 26, 2024</a>.</div>
</footer>
</div>
